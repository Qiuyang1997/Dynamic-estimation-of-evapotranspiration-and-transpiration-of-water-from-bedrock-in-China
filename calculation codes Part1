###----------PART 1 Calculation of the difference of ET-P (A)------------------###
import os
import numpy as np
import rasterio
from rasterio.warp import reproject, Resampling
from datetime import datetime, timedelta
import gc

def process_period_daily(start_date, end_date, base_path):
    # Read the main raster file (calculate the mask) and set the mask
    with rasterio.open(os.path.join(base_path, 'soil thickness mask.tif')) as src:
        mask = src.read(1).astype(bool)  # Convert mask to boolean
        profile = src.profile.copy()
        crs = src.crs
        transform = src.transform
        width = src.width
        height = src.height

    # Initialize the cumulative precipitation
    cumulative_precip = np.zeros((height, width), dtype=np.float32)

    # Generate daily date sequences
    current_date = start_date
    dates = []
    while current_date <= end_date:
        dates.append(current_date.strftime('%Y%m%d'))
        current_date += timedelta(days=1)  # Update time window

    # Create an output folder
    output_a_folder = os.path.join(base_path, 'A__daily')
    os.makedirs(output_a_folder, exist_ok=True)

    # Process daily data
    for date in dates:
        sc_file = os.path.join(base_path, 'snowcover', f'sc{date}.tif')
        pre_file = os.path.join(base_path, 'P', f'P{date}.tif')
        et_file = os.path.join(base_path, 'ET', f'ET{date}.tif')

        try:
            # Read the SC file (snow cover)
            with rasterio.open(sc_file) as src_sc:
                sc_data = np.zeros((height, width), dtype=np.float32)
                reproject(
                    source=src_sc.read(1),
                    src_transform=src_sc.transform,
                    src_crs=src_sc.crs,
                    destination=sc_data,
                    dst_transform=transform,
                    dst_crs=crs,
                    resampling=Resampling.nearest
                )
                sc_data = (sc_data <= 0.1).astype(np.float32)  # Masks converted to 0 or 1

            # Read the precipitation file (P)
            with rasterio.open(pre_file) as src_pre:
                pre_data = np.zeros((height, width), dtype=np.float32)
                reproject(
                    source=src_pre.read(1),
                    src_transform=src_pre.transform,
                    src_crs=src_pre.crs,
                    destination=pre_data,
                    dst_transform=transform,
                    dst_crs=crs,
                    resampling=Resampling.bilinear
                )
                # Replace invalid values and filter outliers
                pre_data = np.nan_to_num(pre_data, nan=0.0, posinf=0.0, neginf=0.0)
                pre_data = np.clip(pre_data, 0, 1000)

            #  Read the ET file (ET)
            with rasterio.open(et_file) as src_et:
                et_data = np.zeros((height, width), dtype=np.float32)
                reproject(
                    source=src_et.read(1),
                    src_transform=src_et.transform,
                    src_crs=src_et.crs,
                    destination=et_data,
                    dst_transform=transform,
                    dst_crs=crs,
                    resampling=Resampling.bilinear
                )
                # Replace invalid values and filter outliers
                et_data = np.nan_to_num(et_data, nan=0.0, posinf=0.0, neginf=0.0)
                et_data = np.clip(et_data, 0, 1000)

            
            cumulative_precip = pre_data 

            # Calculate(ET-P)ï¼Œand apply the snowcover mask
            diff_data = (et_data - cumulative_precip) * sc_data
            #diff_data[~mask] = -9999  # Processing of invalid values outside the mask
            diff_data = np.clip(diff_data, -9999, 1e5)  # Limit the difference norm

            # save results
            output_file_a = os.path.join(output_a_folder, f'A{date}.tif')
            profile.update(dtype='float32', nodata=-9999)
            with rasterio.open(output_file_a, 'w', **profile) as dst:
                dst.write(diff_data.astype(np.float32), 1)

            print(f"Done: {date}")

        except Exception as e:
            print(f"Error processing {date}: {str(e)}")
            continue

        # Release memory
        del diff_data, pre_data, et_data, sc_data
        gc.collect()

    return "All done!"

if __name__ == "__main__":
    base_path = r'I:'
    start_date = datetime(2009, 8, 1)
    end_date = datetime(2020, 7, 31)

    print(process_period_daily(start_date, end_date, base_path))




